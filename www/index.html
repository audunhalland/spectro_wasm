<head>
  <title>WebAssembly Spectro</title>
</head>
<body>
  <script>
    // Need this global variable, which is stupid.
    var Module = {};

    function load_spectro2() {
      return fetch('spectro2.wasm')
        .then(response => response.arrayBuffer())
        .then(buffer => {
          Module.wasmBinary = buffer;

          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'spectro2.js';
            document.body.appendChild(script);
            script.onload = () => {
              console.log('spectro2 loaded!');
              console.log('analyze function: ', Module._analyze);
              resolve(Module);
            };
          });
        });
    }

    function test_memory() {
      const ptr = Module._malloc(4);
      Module.HEAPU32[ptr>>2] = 41;
      const result = Module._add_one(ptr);
      console.log('ptr=%s, result=%s', ptr, result);
      //wm._free(ptr);
    }

    Promise.all([load_spectro2(), navigator.mediaDevices.getUserMedia({ audio: true })])
      .then(([wm, stream]) => {
        const audioBufsize = 2048;
        const gfxWidth = 400;
        const gfxHeight = 300;
        const ctx = new AudioContext();
        const source = ctx.createMediaStreamSource(stream);
        const processor = ctx.createScriptProcessor(audioBufsize, 2, 2);

        test_memory();

        // Audio memory
        const audioBuf = Module._malloc(audioBufsize * 4);

        // Graphics memory
        const gfxSize = gfxWidth * gfxHeight * 4;
        const gfxBuf = Module._malloc(gfxSize);
        const gfxArray = new Uint8ClampedArray(Module.HEAPU8.buffer, gfxBuf, gfxSize);
        const gfx = new ImageData(gfxArray, gfxWidth, gfxHeight);

        const canvas = document.getElementById('canvas');
        const gfxCtx = canvas.getContext('2d');

        processor.onaudioprocess = (event) => {
          // left channel only...
          const jsData = event.inputBuffer.getChannelData(0);

          // "memcpy" data into wasm mem pool
          wm.HEAPF32.set(jsData, audioBuf / 4);

          // Call into wasm
          wm._draw_spectro(audioBuf, audioBufsize, gfxBuf, gfxWidth, gfxHeight);

          gfxCtx.putImageData(gfx, 0, 0);
        };

        source.connect(processor);
        processor.connect(ctx.destination);
      }).catch(err => {
        console.log('error! ', err);
      });
  </script>
  WebAssembly Spectro!
  <canvas id="canvas" width=400 height=300/>
</body>
